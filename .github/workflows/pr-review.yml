name: GMI Agent PR Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install @octokit/rest
      
      - name: Run PR Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node -e "
          const { Octokit } = require('@octokit/rest');
          const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });
          
          async function run() {
            const owner = '${{ github.repository_owner }}';
            const repo = '${{ github.event.repository.name }}';
            const pull_number = ${{ github.event.pull_request.number }};
            
            try {
              // PR íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
              const { data: files } = await octokit.rest.pulls.listFiles({
                owner, repo, pull_number
              });
              
              const comments = [];
              
              files.forEach(file => {
                if (file.filename.endsWith('.js')) {
                  // console.log ì²´í¬
                  if (file.patch && file.patch.includes('console.log')) {
                    comments.push({
                      path: file.filename,
                      line: 1,
                      body: 'âš ï¸ console.log ë°œê²¬! ì œê±°í•˜ì„¸ìš”.'
                    });
                  }
                  // var ì²´í¬
                  if (file.patch && file.patch.includes('var ')) {
                    comments.push({
                      path: file.filename,
                      line: 1,
                      body: 'ğŸ’¡ var ëŒ€ì‹  const/let ì‚¬ìš©í•˜ì„¸ìš”.'
                    });
                  }
                }
              });
              
              // ì½”ë©˜íŠ¸ ì‘ì„±
              if (comments.length > 0) {
                await octokit.rest.pulls.createReview({
                  owner, repo, pull_number,
                  body: 'ğŸ¤– GMI Agent ìë™ ì½”ë“œ ë¦¬ë·° ê²°ê³¼',
                  event: 'COMMENT',
                  comments: comments
                });
                console.log('ë¦¬ë·° ì½”ë©˜íŠ¸ ì‘ì„± ì™„ë£Œ!');
              } else {
                console.log('ë¬¸ì œ ì—†ìŒ!');
              }
            } catch (error) {
              console.error('ì—ëŸ¬:', error.message);
              process.exit(1);
            }
          }
          
          run();
          "
