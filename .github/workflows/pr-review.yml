name: GMI Agent PR Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install @octokit/rest
      
      - name: Run PR Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node -e "
          const { Octokit } = require('@octokit/rest');
          const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });
          
          const owner = '${{ github.repository_owner }}';
          const repo = '${{ github.event.repository.name }}';
          const pull_number = ${{ github.event.pull_request.number }};
          
          // ë³€ê²½ëœ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
          octokit.rest.pulls.listFiles({
            owner, repo, pull_number
          }).then(({ data }) => {
            const comments = [];
            
            data.forEach(file => {
              if (file.filename.endsWith('.js')) {
                // ê°„ë‹¨í•œ ì½”ë“œ ë¶„ì„
                if (file.patch.includes('console.log')) {
                  comments.push({
                    path: file.filename,
                    line: 1,
                    body: 'âš ï¸ console.log ë°œê²¬! ì œê±°í•˜ì„¸ìš”.'
                  });
                }
                if (file.patch.includes('var ')) {
                  comments.push({
                    path: file.filename,
                    line: 1,
                    body: 'ğŸ’¡ var ëŒ€ì‹  const/let ì‚¬ìš©í•˜ì„¸ìš”.'
                  });
                }
              }
            });
            
            // PRì— ì½”ë©˜íŠ¸ ì‘ì„±
            if (comments.length > 0) {
              return octokit.rest.pulls.createReview({
                owner, repo, pull_number,
                body: 'ğŸ¤– GMI Agent ìë™ ì½”ë“œ ë¦¬ë·°',
                event: 'COMMENT',
                comments: comments
              });
            }
          });
          "
